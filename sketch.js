const log = console.log;
const image = document.getElementById('image');
const dropContainer = document.getElementById('container');
const fileInput = document.getElementById('fileUploader');
const ImageSrc = 'images/penguin.jpg'; //default image

const result = document.getElementById('result');
const probability = document.getElementById('probability');
const classifier = ml5.imageClassifier('Mobilenet', () => {
  console.log('Mobilenet loaded');
});

['dragenter', 'dragover'].forEach(eventName => {
  dropContainer.addEventListener(eventName, e =>
    dropContainer.classList.add('highlight')
  );
});

['dragleave', 'drop'].forEach(eventName => {
  dropContainer.addEventListener(eventName, e =>
    dropContainer.classList.remove('highlight')
  );
});

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropContainer.addEventListener(eventName, preventDefaults);
});

dropContainer.addEventListener('drop', gotImage);

classifyImage();

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

function gotImage(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  console.log(files);
  if (files.length > 1) {
    alert('Upload only one file');
  }

  const file = files[0];
  const imageType = /image.*/;
  if (file.type.match(imageType)) {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onloadend = () => {
      image.src = reader.result;
      setTimeout(classifyImage, 100);
    };
  }
}

function classifyImage() {
  classifier.predict(image, (err, results) => {
    if (err) {
      alert('Something went wrong');
    } else {
      console.log(results);
      let resultTxt = results[0].className;
      result.innerText = resultTxt;
      let prob = 100 * results[0].probability;
      probability.innerText = Number.parseFloat(prob).toFixed(2) + '%';
    }
  });
}

function handleFiles() {
  const curFiles = fileInput.files;
  if (curFiles.length === 0) {
    image.src = ImageSrc;
    setTimeout(classifyImage, 100);
  }
}

function clickUploader() {
  fileInput.click();
}
